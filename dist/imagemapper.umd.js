(function(y,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(y=typeof globalThis<"u"?globalThis:y||self,v(y.imagemapper={}))})(this,function(y){"use strict";var In=Object.defineProperty;var Dn=(y,v,C)=>v in y?In(y,v,{enumerable:!0,configurable:!0,writable:!0,value:C}):y[v]=C;var m=(y,v,C)=>(Dn(y,typeof v!="symbol"?v+"":v,C),C);const v="http://www.w3.org/2000/svg",C="http://www.w3.org/1999/xlink";let F,S;window!=null?(F=window,S=F.document):(F=globalThis,S=F.document);const O=function(n,t,e){[n].flat().forEach(s=>{t.split(" ").forEach(i=>{s.addEventListener(i,e,{passive:!1})})})},he=function(n,t,e){[n].flat().forEach(s=>{t.split(" ").forEach(i=>{s.removeEventListener(i,e)})})},ae={fill:"rgb(102, 102, 102)",stroke:"rgb(51, 51, 51)",cursor:"pointer"},le={off:{strokeWidth:"1",opacity:"0.5"},on:{strokeWidth:"2",opacity:"0.6"}},de={off:{strokeDasharray:"none",strokeLinejoin:"miter"},on:{strokeDasharray:"4 3",strokeLinejoin:"round"}},ue={fill:"rgb(255, 255, 255)",stroke:"rgb(51, 51, 51)",strokeWidth:"1",opacity:"0.3",cursor:"pointer"},fe={opacity:"0.6"},wt=()=>({component:Object.assign({},ae),componentHover:Object.assign({},le),componentSelect:Object.assign({},de),handle:Object.assign({},ue),handleHover:Object.assign({},fe)}),b=(n,t)=>Object.entries(t).forEach(([e,s])=>n.setAttribute(e,s)),tt=(n,t,e)=>{O(n,"mouseenter touchstart",()=>b(n,e)),O(n,"mouseleave touchend touchleave",()=>b(n,t))};class M{constructor(t,e){m(this,"style",wt());m(this,"isSelected",!1);m(this,"isFrozen",!1);this.editorOwner=t,this.element=e}_logWarnOnOpOnFrozen(t){this.isFrozen&&console.warn(`${t} frozen ${this.element.tagName} with id ${this.element.id}`)}}class x{constructor(t,e,s,i){m(this,"moveHandler");m(this,"element");m(this,"isFrozen");this.moveHandler=s,this.element=S.createElementNS(v,"circle"),this.element.setAttribute("cx",String(t)),this.element.setAttribute("cy",String(e)),this.element.setAttribute("r","5"),this.element.setAttribute("visibility","hidden"),this.isFrozen=i!=null?!!i:!1}freeze(t){return this.isFrozen=t!=null?!!t:!0,this.isFrozen&&this.setVisible(!1),this}setAttrX(t){return this.element.setAttribute("cx",String(t)),this}setAttrY(t){return this.element.setAttribute("cy",String(t)),this}move(t,e){return this.moveHandler(t,e),this}setVisible(t){return t=t!=null?!!t:!0,this.element.setAttribute("visibility",t?"visible":"hidden"),this}setStyle(t,e){return b(this.element,t),tt(this.element,t,e),this}}const et=(n,t,e)=>{const s={defineProperty(i,o,r){return Object.is(r.value,i[o])||(typeof t=="function"?t.call(e||this,o,r.value,i[o],n):t[o].call(e||this,r.value,i[o],n)),Reflect.defineProperty(i,o,r)}};return new Proxy(n,s)};class P extends M{constructor(e,s,i,o,r,c=0,a=0){super(i,S.createElementNS(v,e));m(this,"dim");m(this,"handles");this.dim=et({x:o,y:r,width:0,height:0},{x:(h,l,d)=>{this._logWarnOnOpOnFrozen("Dimension property x changed on"),s.x.call(this,this.element,h,l,d),this.handles[0].setAttrX(h),this.handles[1].setAttrX(h),this.handles[2].setAttrX(h+d.width),this.handles[3].setAttrX(h+d.width)},y:(h,l,d)=>{this._logWarnOnOpOnFrozen("Dimension property y changed on"),s.y.call(this,this.element,h,l,d),this.handles[0].setAttrY(h),this.handles[1].setAttrY(h+d.height),this.handles[2].setAttrY(h),this.handles[3].setAttrY(h+d.height)},width:(h,l,d)=>{this._logWarnOnOpOnFrozen("Dimension property width changed on"),s.width.call(this,this.element,h,l,d),this.handles[2].setAttrX(d.x+h),this.handles[3].setAttrX(d.x+h)},height:(h,l,d)=>{this._logWarnOnOpOnFrozen("Dimension property height changed on"),s.height.call(this,this.element,h,l,d),this.handles[1].setAttrY(d.y+h),this.handles[3].setAttrY(d.y+h)}},this),this.handles=[new x(o,r,(h,l)=>{this.dim.x+=h,this.dim.width-=h,this.dim.y+=l,this.dim.height-=l},this.isFrozen),new x(o,r,(h,l)=>{this.dim.x+=h,this.dim.width-=h,this.dim.height+=l},this.isFrozen),new x(o,r,(h,l)=>{this.dim.width+=h,this.dim.y+=l,this.dim.height-=l},this.isFrozen),new x(o,r,(h,l)=>{this.dim.width+=h,this.dim.height+=l},this.isFrozen)],this.handles.forEach(h=>{this.editorOwner.registerComponentHandle(h)}),[this.dim.width,this.dim.height]=[c,a]}freeze(e){return this.isFrozen=e!=null?!!e:!0,this.handles.forEach(s=>s.freeze(e)),this}resize(e,s){return this.dim.width=e-this.dim.x,this.dim.height=s-this.dim.y,this}move(e,s){return this.dim.x+=e,this.dim.y+=s,this}isValid(){return this.dim.width!==0&&this.dim.height!==0}setHandlesVisibility(e){return this.handles.forEach(s=>s.setVisible(e)),this}setIsSelected(e){return this._logWarnOnOpOnFrozen("Select/unselect performed on"),this.isSelected=e=e!=null?!!e:!0,this.setHandlesVisibility(e),this.style&&b(this.element,e?this.style.componentSelect.on:this.style.componentSelect.off),this}getHandles(){return this.handles}setStyle(e){return this.style=e,b(this.element,e.component),b(this.element,e.componentHover.off),b(this.element,e.componentSelect.off),tt(this.element,e.componentHover.off,e.componentHover.on),this}export(){const{x:e,y:s,width:i,height:o}=this.dim;return{x:e,y:s,width:i,height:o}}}function pe(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function ge(){const n=pe();if(n.__xstate__)return n.__xstate__}const me=n=>{if(typeof window>"u")return;const t=ge();t&&t.register(n)};class St{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const e={value:t,next:null};if(this._current){this._last.next=e,this._last=e;return}this._current=e,this._last=e,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const B=".",ye="",bt="",ve="#",_e="*",Et="xstate.init",we="xstate.error",nt="xstate.stop";function Se(n,t){return{type:`xstate.after.${n}.${t}`}}function st(n,t){return{type:`xstate.done.state.${n}`,output:t}}function be(n,t){return{type:`xstate.done.actor.${n}`,output:t}}function xt(n,t){return{type:`xstate.error.actor.${n}`,error:t}}function At(n){return{type:Et,input:n}}function A(n){setTimeout(()=>{throw n})}const Ee=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Ot(n,t){return`${n.sessionId}.${t}`}let xe=0;function Ae(n,t){const e=new Map,s=new Map,i=new WeakMap,o=new Set,r={},c=t.clock,a={schedule:(l,d,u,f,p=Math.random().toString(36).slice(2))=>{const g={source:l,target:d,event:u,delay:f,id:p,startedAt:Date.now()},_=Ot(l,p);h._snapshot._scheduledEvents[_]=g;const Tn=c.setTimeout(()=>{delete r[_],delete h._snapshot._scheduledEvents[_],h._relay(l,d,u)},f);r[_]=Tn},cancel:(l,d)=>{const u=Ot(l,d),f=r[u];delete r[u],delete h._snapshot._scheduledEvents[u],c.clearTimeout(f)},cancelAll:l=>{for(const d in h._snapshot._scheduledEvents){const u=h._snapshot._scheduledEvents[d];u.source===l&&a.cancel(l,u.id)}}},h={_snapshot:{_scheduledEvents:((t==null?void 0:t.snapshot)&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${xe++}`,_register:(l,d)=>(e.set(l,d),l),_unregister:l=>{e.delete(l.sessionId);const d=i.get(l);d!==void 0&&(s.delete(d),i.delete(l))},get:l=>s.get(l),_set:(l,d)=>{const u=s.get(l);if(u&&u!==d)throw new Error(`Actor with system ID '${l}' already exists.`);s.set(l,d),i.set(d,l)},inspect:l=>{o.add(l)},_sendInspectionEvent:l=>{const d={...l,rootId:n.sessionId};o.forEach(u=>{var f;return(f=u.next)==null?void 0:f.call(u,d)})},_relay:(l,d,u)=>{h._sendInspectionEvent({type:"@xstate.event",sourceRef:l,actorRef:d,event:u}),d._send(u)},scheduler:a,getSnapshot:()=>({_scheduledEvents:{...h._snapshot._scheduledEvents}}),start:()=>{const l=h._snapshot._scheduledEvents;h._snapshot._scheduledEvents={};for(const d in l){const{source:u,target:f,event:p,delay:g,id:_}=l[d];a.schedule(u,f,p,g,_)}}};return h}function Mt(n,t){const e=It(n),s=It(t);return typeof s=="string"?typeof e=="string"?s===e:!1:typeof e=="string"?e in s:Object.keys(e).every(i=>i in s?Mt(e[i],s[i]):!1)}function Tt(n){return kt(n)?n:n.split(B)}function It(n){if(tn(n))return n.value;if(typeof n!="string")return n;const t=Tt(n);return Oe(t)}function Oe(n){if(n.length===1)return n[0];const t={};let e=t;for(let s=0;s<n.length-1;s++)if(s===n.length-2)e[n[s]]=n[s+1];else{const i=e;e={},i[n[s]]=e}return t}function Dt(n,t){const e={},s=Object.keys(n);for(let i=0;i<s.length;i++){const o=s[i];e[o]=t(n[o],o,n,i)}return e}function Ct(n){return kt(n)?n:[n]}function T(n){return n===void 0?[]:Ct(n)}function it(n,t,e,s){return typeof n=="function"?n({context:t,event:e,self:s}):n}function kt(n){return Array.isArray(n)}function Me(n){return n.type.startsWith("xstate.error.actor")}function j(n){return Ct(n).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function $t(n){if(!(n===void 0||n===ye))return T(n)}function Rt(n,t,e){var o,r,c;const s=typeof n=="object",i=s?n:void 0;return{next:(o=s?n.next:n)==null?void 0:o.bind(i),error:(r=s?n.error:t)==null?void 0:r.bind(i),complete:(c=s?n.complete:e)==null?void 0:c.bind(i)}}function jt(n,t){return`${t}.${n}`}function ot(n,t){const e=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!e)return n.implementations.actors[t];const[,s,i]=e,r=n.getStateNodeById(i).config.invoke;return(Array.isArray(r)?r[s]:r).src}const rt=1;let w=function(n){return n[n.NotStarted=0]="NotStarted",n[n.Running=1]="Running",n[n.Stopped=2]="Stopped",n}({});const Te={clock:{setTimeout:(n,t)=>setTimeout(n,t),clearTimeout:n=>clearTimeout(n)},logger:console.log.bind(console),devTools:!1};class Ie{constructor(t,e){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new St(this._process.bind(this)),this.observers=new Set,this.logger=void 0,this._processingStatus=w.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...Te,...e},{clock:i,logger:o,parent:r,syncSnapshot:c,id:a,systemId:h,inspect:l}=s;this.system=r?r.system:Ae(this,{clock:i}),l&&!r&&this.system.inspect(Rt(l)),this.sessionId=this.system._bookId(),this.id=a??this.sessionId,this.logger=o,this.clock=i,this._parent=r,this._syncSnapshot=c,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),h&&(this._systemId=h,this.system._set(h,this)),this._initState((e==null?void 0:e.snapshot)??(e==null?void 0:e.state)),h&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){var e;try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,(e=this.options)==null?void 0:e.input)}catch(s){this._snapshot={status:"error",output:void 0,error:s}}}update(t,e){var i,o;this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(r){this._deferred.length=0,this._snapshot={...t,status:"error",error:r}}switch(this._snapshot.status){case"active":for(const r of this.observers)try{(i=r.next)==null||i.call(r,t)}catch(c){A(c)}break;case"done":for(const r of this.observers)try{(o=r.next)==null||o.call(r,t)}catch(c){A(c)}this._stopProcedure(),this._complete(),this._doneEvent=be(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:e,snapshot:t})}subscribe(t,e,s){var o;const i=Rt(t,e,s);if(this._processingStatus!==w.Stopped)this.observers.add(i);else switch(this._snapshot.status){case"done":try{(o=i.complete)==null||o.call(i)}catch(r){A(r)}break;case"error":{const r=this._snapshot.error;if(!i.error)A(r);else try{i.error(r)}catch(c){A(c)}break}}return{unsubscribe:()=>{this.observers.delete(i)}}}start(){if(this._processingStatus===w.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=w.Running;const t=At(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let e,s;try{e=this.logic.transition(this._snapshot,t,this._actorScope)}catch(i){s={err:i}}if(s){const{err:i}=s;this._snapshot={...this._snapshot,status:"error",error:i},this._error(i);return}this.update(e,t),t.type===nt&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===w.Stopped?this:(this.mailbox.clear(),this._processingStatus===w.NotStarted?(this._processingStatus=w.Stopped,this):(this.mailbox.enqueue({type:nt}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){var t;for(const e of this.observers)try{(t=e.complete)==null||t.call(e)}catch(s){A(s)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||A(t);return}let e=!1;for(const s of this.observers){const i=s.error;e||(e=!i);try{i==null||i(t)}catch(o){A(o)}}this.observers.clear(),e&&A(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,xt(this.id,t))}_stopProcedure(){return this._processingStatus!==w.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new St(this._process.bind(this)),this._processingStatus=w.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==w.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:me)(this)}toJSON(){return{xstate$$type:rt,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[Ee](){return this}getSnapshot(){return this._snapshot}}function X(n,t){return new Ie(n,t)}function De(n,t,e,s,{sendId:i}){const o=typeof i=="function"?i(e,s):i;return[t,o]}function Ce(n,t){n.defer(()=>{n.system.scheduler.cancel(n.self,t)})}function Wt(n){function t(e,s){}return t.type="xstate.cancel",t.sendId=n,t.resolve=De,t.execute=Ce,t}function ke(n,t,e,s,{id:i,systemId:o,src:r,input:c,syncSnapshot:a}){const h=typeof r=="string"?ot(t.machine,r):r,l=typeof i=="function"?i(e):i;let d;return h&&(d=X(h,{id:l,src:r,parent:n==null?void 0:n.self,syncSnapshot:a,systemId:o,input:typeof c=="function"?c({context:t.context,event:e.event,self:n==null?void 0:n.self}):c})),[R(t,{children:{...t.children,[l]:d}}),{id:i,actorRef:d}]}function $e(n,{id:t,actorRef:e}){e&&n.defer(()=>{e._processingStatus!==w.Stopped&&e.start()})}function Yt(...[n,{id:t,systemId:e,input:s,syncSnapshot:i=!1}={}]){function o(r,c){}return o.type="snapshot.spawnChild",o.id=t,o.systemId=e,o.src=n,o.input=s,o.syncSnapshot=i,o.resolve=ke,o.execute=$e,o}function Re(n,t,e,s,{actorRef:i}){const o=typeof i=="function"?i(e,s):i,r=typeof o=="string"?t.children[o]:o;let c=t.children;return r&&(c={...c},delete c[r.id]),[R(t,{children:c}),r]}function je(n,t){if(t){if(n.system._unregister(t),t._processingStatus!==w.Running){n.stopChild(t);return}n.defer(()=>{n.stopChild(t)})}}function ct(n){function t(e,s){}return t.type="xstate.stopChild",t.actorRef=n,t.resolve=Re,t.execute=je,t}function J(n,t,e,s){const{machine:i}=s,o=typeof n=="function",r=o?n:i.implementations.guards[typeof n=="string"?n:n.type];if(!o&&!r)throw new Error(`Guard '${typeof n=="string"?n:n.type}' is not implemented.'.`);if(typeof r!="function")return J(r,t,e,s);const c={context:t,event:e},a=o||typeof n=="string"?void 0:"params"in n?typeof n.params=="function"?n.params({context:t,event:e}):n.params:void 0;return"check"in r?r.check(s,c,r):r(c,a)}const ht=n=>n.type==="atomic"||n.type==="final";function W(n){return Object.values(n.states).filter(t=>t.type!=="history")}function L(n,t){const e=[];if(t===n)return e;let s=n.parent;for(;s&&s!==t;)e.push(s),s=s.parent;return e}function V(n){const t=new Set(n),e=Ut(t);for(const s of t)if(s.type==="compound"&&(!e.get(s)||!e.get(s).length))Xt(s).forEach(i=>t.add(i));else if(s.type==="parallel"){for(const i of W(s))if(i.type!=="history"&&!t.has(i)){const o=Xt(i);for(const r of o)t.add(r)}}for(const s of t){let i=s.parent;for(;i;)t.add(i),i=i.parent}return t}function Ht(n,t){const e=t.get(n);if(!e)return{};if(n.type==="compound"){const i=e[0];if(i){if(ht(i))return i.key}else return{}}const s={};for(const i of e)s[i.key]=Ht(i,t);return s}function Ut(n){const t=new Map;for(const e of n)t.has(e)||t.set(e,[]),e.parent&&(t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e));return t}function zt(n,t){const e=V(t);return Ht(n,Ut(e))}function at(n,t){return t.type==="compound"?W(t).some(e=>e.type==="final"&&n.has(e)):t.type==="parallel"?W(t).every(e=>at(n,e)):t.type==="final"}const K=n=>n[0]===ve;function We(n,t){return n.transitions.get(t)||[...n.transitions.keys()].filter(s=>{if(s===_e)return!0;if(!s.endsWith(".*"))return!1;const i=s.split("."),o=t.split(".");for(let r=0;r<i.length;r++){const c=i[r],a=o[r];if(c==="*")return r===i.length-1;if(c!==a)return!1}return!0}).sort((s,i)=>i.length-s.length).flatMap(s=>n.transitions.get(s))}function Ye(n){const t=n.config.after;if(!t)return[];const e=(i,o)=>{const r=Se(i,n.id),c=r.type;return n.entry.push(Gt(r,{id:c,delay:i})),n.exit.push(Wt(c)),c};return Object.keys(t).flatMap((i,o)=>{const r=t[i],c=typeof r=="string"?{target:r}:r,a=Number.isNaN(+i)?i:+i,h=e(a);return T(c).map(l=>({...l,event:h,delay:a}))}).map(i=>{const{delay:o}=i;return{...k(n,i.event,i),delay:o}})}function k(n,t,e){const s=$t(e.target),i=e.reenter??!1,o=ze(n,s),r={...e,actions:T(e.actions),guard:e.guard,target:o,source:n,reenter:i,eventType:t,toJSON:()=>({...r,source:`#${n.id}`,target:o?o.map(c=>`#${c.id}`):void 0})};return r}function He(n){const t=new Map;if(n.config.on)for(const e of Object.keys(n.config.on)){if(e===bt)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=n.config.on[e];t.set(e,j(s).map(i=>k(n,e,i)))}if(n.config.onDone){const e=`xstate.done.state.${n.id}`;t.set(e,j(n.config.onDone).map(s=>k(n,e,s)))}for(const e of n.invoke){if(e.onDone){const s=`xstate.done.actor.${e.id}`;t.set(s,j(e.onDone).map(i=>k(n,s,i)))}if(e.onError){const s=`xstate.error.actor.${e.id}`;t.set(s,j(e.onError).map(i=>k(n,s,i)))}if(e.onSnapshot){const s=`xstate.snapshot.${e.id}`;t.set(s,j(e.onSnapshot).map(i=>k(n,s,i)))}}for(const e of n.after){let s=t.get(e.eventType);s||(s=[],t.set(e.eventType,s)),s.push(e)}return t}function Ue(n,t){const e=typeof t=="string"?n.states[t]:t?n.states[t.target]:void 0;if(!e&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${n.id}`);const s={source:n,actions:!t||typeof t=="string"?[]:T(t.actions),eventType:null,reenter:!1,target:e?[e]:[],toJSON:()=>({...s,source:`#${n.id}`,target:e?[`#${e.id}`]:[]})};return s}function ze(n,t){if(t!==void 0)return t.map(e=>{if(typeof e!="string")return e;if(K(e))return n.machine.getStateNodeById(e);const s=e[0]===B;if(s&&!n.parent)return q(n,e.slice(1));const i=s?n.key+e:e;if(n.parent)try{return q(n.parent,i)}catch(o){throw new Error(`Invalid transition definition for state node '${n.id}':
${o.message}`)}else throw new Error(`Invalid target: "${e}" is not a valid target from the root node. Did you mean ".${e}"?`)})}function Pt(n){const t=$t(n.config.target);return t?{target:t.map(e=>typeof e=="string"?q(n.parent,e):e)}:n.parent.initial}function $(n){return n.type==="history"}function Xt(n){const t=Lt(n);for(const e of t)for(const s of L(e,n))t.add(s);return t}function Lt(n){const t=new Set;function e(s){if(!t.has(s)){if(t.add(s),s.type==="compound")e(s.initial.target[0]);else if(s.type==="parallel")for(const i of W(s))e(i)}}return e(n),t}function Y(n,t){if(K(t))return n.machine.getStateNodeById(t);if(!n.states)throw new Error(`Unable to retrieve child state '${t}' from '${n.id}'; no child states exist.`);const e=n.states[t];if(!e)throw new Error(`Child state '${t}' does not exist on '${n.id}'`);return e}function q(n,t){if(typeof t=="string"&&K(t))try{return n.machine.getStateNodeById(t)}catch{}const e=Tt(t).slice();let s=n;for(;e.length;){const i=e.shift();if(!i.length)break;s=Y(s,i)}return s}function G(n,t){if(typeof t=="string")return[n,n.states[t]];const e=Object.keys(t),s=e.map(i=>Y(n,i)).filter(Boolean);return[n.machine.root,n].concat(s,e.reduce((i,o)=>{const r=Y(n,o);if(!r)return i;const c=G(r,t[o]);return i.concat(c)},[]))}function Pe(n,t,e,s){const o=Y(n,t).next(e,s);return!o||!o.length?n.next(e,s):o}function Xe(n,t,e,s){const i=Object.keys(t),o=Y(n,i[0]),r=lt(o,t[i[0]],e,s);return!r||!r.length?n.next(e,s):r}function Le(n,t,e,s){const i=[];for(const o of Object.keys(t)){const r=t[o];if(!r)continue;const c=Y(n,o),a=lt(c,r,e,s);a&&i.push(...a)}return i.length?i:n.next(e,s)}function lt(n,t,e,s){return typeof t=="string"?Pe(n,t,e,s):Object.keys(t).length===1?Xe(n,t,e,s):Le(n,t,e,s)}function Ne(n){return Object.keys(n.states).map(t=>n.states[t]).filter(t=>t.type==="history")}function I(n,t){let e=n;for(;e.parent&&e.parent!==t;)e=e.parent;return e.parent===t}function Fe(n,t){const e=new Set(n),s=new Set(t);for(const i of e)if(s.has(i))return!0;for(const i of s)if(e.has(i))return!0;return!1}function Nt(n,t,e){const s=new Set;for(const i of n){let o=!1;const r=new Set;for(const c of s)if(Fe(ut([i],t,e),ut([c],t,e)))if(I(i.source,c.source))r.add(c);else{o=!0;break}if(!o){for(const c of r)s.delete(c);s.add(i)}}return Array.from(s)}function Be(n){const[t,...e]=n;for(const s of L(t,void 0))if(e.every(i=>I(i,s)))return s}function dt(n,t){if(!n.target)return[];const e=new Set;for(const s of n.target)if($(s))if(t[s.id])for(const i of t[s.id])e.add(i);else for(const i of dt(Pt(s),t))e.add(i);else e.add(s);return[...e]}function Ft(n,t){const e=dt(n,t);if(!e)return;if(!n.reenter&&e.every(i=>i===n.source||I(i,n.source)))return n.source;const s=Be(e.concat(n.source));if(s)return s;if(!n.reenter)return n.source.machine.root}function ut(n,t,e){var i;const s=new Set;for(const o of n)if((i=o.target)!=null&&i.length){const r=Ft(o,e);o.reenter&&o.source===r&&s.add(r);for(const c of t)I(c,r)&&s.add(c)}return[...s]}function Je(n,t){if(n.length!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;return!0}function ft(n,t,e,s,i,o){if(!n.length)return t;const r=new Set(t._nodes);let c=t.historyValue;const a=Nt(n,r,c);let h=t;i||([h,c]=Ge(h,s,e,a,r,c,o)),h=U(h,s,e,a.flatMap(d=>d.actions),o),h=Ke(h,s,e,a,r,o,c,i);const l=[...r];h.status==="done"&&(h=U(h,s,e,l.sort((d,u)=>u.order-d.order).flatMap(d=>d.exit),o));try{return c===t.historyValue&&Je(t._nodes,r)?h:R(h,{_nodes:l,historyValue:c})}catch(d){throw d}}function Ve(n,t,e,s,i){if(!s.output)return;const o=st(i.id,i.output&&i.parent?it(i.output,n.context,t,e.self):void 0);return it(s.output,n.context,o,e.self)}function Ke(n,t,e,s,i,o,r,c){let a=n;const h=new Set,l=new Set;qe(s,r,l,h),c&&l.add(n.machine.root);const d=new Set;for(const u of[...h].sort((f,p)=>f.order-p.order)){i.add(u);const f=[];f.push(...u.entry);for(const p of u.invoke)f.push(Yt(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(l.has(u)){const p=u.initial.actions;f.push(...p)}if(a=U(a,t,e,f,o,u.invoke.map(p=>p.id)),u.type==="final"){const p=u.parent;let g=(p==null?void 0:p.type)==="parallel"?p:p==null?void 0:p.parent,_=g||u;for((p==null?void 0:p.type)==="compound"&&o.push(st(p.id,u.output?it(u.output,a.context,t,e.self):void 0));(g==null?void 0:g.type)==="parallel"&&!d.has(g)&&at(i,g);)d.add(g),o.push(st(g.id)),_=g,g=g.parent;if(g)continue;a=R(a,{status:"done",output:Ve(a,t,e,a.machine.root,_)})}}return a}function qe(n,t,e,s){for(const i of n){const o=Ft(i,t);for(const c of i.target||[])!$(c)&&(i.source!==c||i.source!==o||i.reenter)&&(s.add(c),e.add(c)),H(c,t,e,s);const r=dt(i,t);for(const c of r){const a=L(c,o);(o==null?void 0:o.type)==="parallel"&&a.push(o),Bt(s,t,e,a,!i.source.parent&&i.reenter?void 0:o)}}}function H(n,t,e,s){var i;if($(n))if(t[n.id]){const o=t[n.id];for(const r of o)s.add(r),H(r,t,e,s);for(const r of o)pt(r,n.parent,s,t,e)}else{const o=Pt(n);for(const r of o.target)s.add(r),o===((i=n.parent)==null?void 0:i.initial)&&e.add(n.parent),H(r,t,e,s);for(const r of o.target)pt(r,n.parent,s,t,e)}else if(n.type==="compound"){const[o]=n.initial.target;$(o)||(s.add(o),e.add(o)),H(o,t,e,s),pt(o,n,s,t,e)}else if(n.type==="parallel")for(const o of W(n).filter(r=>!$(r)))[...s].some(r=>I(r,o))||($(o)||(s.add(o),e.add(o)),H(o,t,e,s))}function Bt(n,t,e,s,i){for(const o of s)if((!i||I(o,i))&&n.add(o),o.type==="parallel")for(const r of W(o).filter(c=>!$(c)))[...n].some(c=>I(c,r))||(n.add(r),H(r,t,e,n))}function pt(n,t,e,s,i){Bt(e,s,i,L(n,t))}function Ge(n,t,e,s,i,o,r){let c=n;const a=ut(s,i,o);a.sort((l,d)=>d.order-l.order);let h;for(const l of a)for(const d of Ne(l)){let u;d.history==="deep"?u=f=>ht(f)&&I(f,l):u=f=>f.parent===l,h??(h={...o}),h[d.id]=Array.from(i).filter(u)}for(const l of a)c=U(c,t,e,[...l.exit,...l.invoke.map(d=>ct(d.id))],r),i.delete(l);return[c,h||o]}function Jt(n,t,e,s,i,o){const{machine:r}=n;let c=n;for(const a of s){const h=typeof a=="function",l=h?a:r.implementations.actions[typeof a=="string"?a:a.type];if(!l)continue;const d={context:c.context,event:t,self:e==null?void 0:e.self,system:e==null?void 0:e.system},u=h||typeof a=="string"?void 0:"params"in a?typeof a.params=="function"?a.params({context:c.context,event:t}):a.params:void 0;if(!("resolve"in l)){(e==null?void 0:e.self._processingStatus)===w.Running?l(d,u):e==null||e.defer(()=>{l(d,u)});continue}const f=l,[p,g,_]=f.resolve(e,c,d,u,l,i);c=p,"retryResolve"in f&&(o==null||o.push([f,g])),"execute"in f&&((e==null?void 0:e.self._processingStatus)===w.Running?f.execute(e,g):e==null||e.defer(f.execute.bind(null,e,g))),_&&(c=Jt(c,t,e,_,i,o))}return c}function U(n,t,e,s,i,o){const r=o?[]:void 0,c=Jt(n,t,e,s,{internalQueue:i,deferredActorIds:o},r);return r==null||r.forEach(([a,h])=>{a.retryResolve(e,c,h)}),c}function gt(n,t,e,s=[]){let i=n;const o=[];if(t.type===nt)return i=R(Vt(i,t,e),{status:"stopped"}),o.push(i),{snapshot:i,microstates:o};let r=t;if(r.type!==Et){const a=r,h=Me(a),l=Kt(a,i);if(h&&!l.length)return i=R(n,{status:"error",error:a.error}),o.push(i),{snapshot:i,microstates:o};i=ft(l,n,e,r,!1,s),o.push(i)}let c=!0;for(;i.status==="active";){let a=c?Ze(i,r):[];const h=a.length?i:void 0;if(!a.length){if(!s.length)break;r=s.shift(),a=Kt(r,i)}i=ft(a,i,e,r,!1,s),c=i!==h,o.push(i)}return i.status!=="active"&&Vt(i,r,e),{snapshot:i,microstates:o}}function Vt(n,t,e){return U(n,t,e,Object.values(n.children).map(s=>ct(s)),[])}function Kt(n,t){return t.machine.getTransitionData(t,n)}function Ze(n,t){const e=new Set,s=n._nodes.filter(ht);for(const i of s)t:for(const o of[i].concat(L(i,void 0)))if(o.always){for(const r of o.always)if(r.guard===void 0||J(r.guard,n.context,t,n)){e.add(r);break t}}return Nt(Array.from(e),new Set(n._nodes),n.historyValue)}function Qe(n,t){const e=V(G(n,t));return zt(n,[...e])}function tn(n){return!!n&&typeof n=="object"&&"machine"in n&&"value"in n}const en=function(t){return Mt(t,this.value)},nn=function(t){return this.tags.has(t)},sn=function(t){const e=this.machine.getTransitionData(this,t);return!!(e!=null&&e.length)&&e.some(s=>s.target!==void 0||s.actions.length)},on=function(){const{_nodes:t,tags:e,machine:s,getMeta:i,toJSON:o,can:r,hasTag:c,matches:a,...h}=this;return{...h,tags:Array.from(e)}},rn=function(){return this._nodes.reduce((t,e)=>(e.meta!==void 0&&(t[e.id]=e.meta),t),{})};function Z(n,t){return{status:n.status,output:n.output,error:n.error,machine:t,context:n.context,_nodes:n._nodes,value:zt(t.root,n._nodes),tags:new Set(n._nodes.flatMap(e=>e.tags)),children:n.children,historyValue:n.historyValue||{},matches:en,hasTag:nn,can:sn,getMeta:rn,toJSON:on}}function R(n,t={}){return Z({...n,...t},n.machine)}function cn(n,t){const{_nodes:e,tags:s,machine:i,children:o,context:r,can:c,hasTag:a,matches:h,getMeta:l,toJSON:d,...u}=n,f={};for(const g in o){const _=o[g];f[g]={snapshot:_.getPersistedSnapshot(t),src:_.src,systemId:_._systemId,syncSnapshot:_._syncSnapshot}}return{...u,context:qt(r),children:f}}function qt(n){let t;for(const e in n){const s=n[e];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??(t=Array.isArray(n)?n.slice():{...n}),t[e]={xstate$$type:rt,id:s.id};else{const i=qt(s);i!==s&&(t??(t=Array.isArray(n)?n.slice():{...n}),t[e]=i)}}return t??n}function hn(n,t,e,s,{event:i,id:o,delay:r},{internalQueue:c}){const a=t.machine.implementations.delays;if(typeof i=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${i}" }) instead`);const h=typeof i=="function"?i(e,s):i;let l;if(typeof r=="string"){const d=a&&a[r];l=typeof d=="function"?d(e,s):d}else l=typeof r=="function"?r(e,s):r;return typeof l!="number"&&c.push(h),[t,{event:h,id:o,delay:l}]}function an(n,t){const{event:e,delay:s,id:i}=t;if(typeof s=="number"){n.defer(()=>{const o=n.self;n.system.scheduler.schedule(o,o,e,s,i)});return}}function Gt(n,t){function e(s,i){}return e.type="xstate.raise",e.event=n,e.id=t==null?void 0:t.id,e.delay=t==null?void 0:t.delay,e.resolve=hn,e.execute=an,e}function ln(n,{machine:t,context:e},s,i){const o=(r,c={})=>{const{systemId:a,input:h}=c;if(typeof r=="string"){const l=ot(t,r);if(!l)throw new Error(`Actor logic '${r}' not implemented in machine '${t.id}'`);const d=X(l,{id:c.id,parent:n.self,syncSnapshot:c.syncSnapshot,input:typeof h=="function"?h({context:e,event:s,self:n.self}):h,src:r,systemId:a});return i[d.id]=d,d}else return X(r,{id:c.id,parent:n.self,syncSnapshot:c.syncSnapshot,input:c.input,src:r,systemId:a})};return(r,c)=>{const a=o(r,c);return i[a.id]=a,n.defer(()=>{a._processingStatus!==w.Stopped&&a.start()}),a}}function dn(n,t,e,s,{assignment:i}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const o={},r={context:t.context,event:e.event,spawn:ln(n,t,e.event,o),self:n==null?void 0:n.self,system:n==null?void 0:n.system};let c={};if(typeof i=="function")c=i(r,s);else for(const h of Object.keys(i)){const l=i[h];c[h]=typeof l=="function"?l(r,s):l}const a=Object.assign({},t.context,c);return[R(t,{context:a,children:Object.keys(o).length?{...t.children,...o}:t.children})]}function D(n){function t(e,s){}return t.type="xstate.assign",t.assignment=n,t.resolve=dn,t}let Zt=function(n){return n.Parent="#_parent",n.Internal="#_internal",n}({});function un(n,t,e,s,{to:i,event:o,id:r,delay:c},a){var p;const h=t.machine.implementations.delays;if(typeof o=="string")throw new Error(`Only event objects may be used with sendTo; use sendTo({ type: "${o}" }) instead`);const l=typeof o=="function"?o(e,s):o;let d;if(typeof c=="string"){const g=h&&h[c];d=typeof g=="function"?g(e,s):g}else d=typeof c=="function"?c(e,s):c;const u=typeof i=="function"?i(e,s):i;let f;if(typeof u=="string"){if(u===Zt.Parent?f=n==null?void 0:n.self._parent:u===Zt.Internal?f=n==null?void 0:n.self:u.startsWith("#_")?f=t.children[u.slice(2)]:f=(p=a.deferredActorIds)!=null&&p.includes(u)?u:t.children[u],!f)throw new Error(`Unable to send event to actor '${u}' from machine '${t.machine.id}'.`)}else f=u||(n==null?void 0:n.self);return[t,{to:f,event:l,id:r,delay:d}]}function fn(n,t,e){typeof e.to=="string"&&(e.to=t.children[e.to])}function pn(n,t){n.defer(()=>{const{to:e,event:s,delay:i,id:o}=t;if(typeof i=="number"){n.system.scheduler.schedule(n.self,e,s,i,o);return}n.system._relay(n.self,e,s.type===we?xt(n.self.id,s.data):s)})}function gn(n,t,e){function s(i,o){}return s.type="xsnapshot.sendTo",s.to=n,s.event=t,s.id=e==null?void 0:e.id,s.delay=e==null?void 0:e.delay,s.resolve=un,s.retryResolve=fn,s.execute=pn,s}function mn(n,t,e,s,{collect:i}){const o=[],r=function(a){o.push(a)};return r.assign=(...c)=>{o.push(D(...c))},r.cancel=(...c)=>{o.push(Wt(...c))},r.raise=(...c)=>{o.push(Gt(...c))},r.sendTo=(...c)=>{o.push(gn(...c))},r.spawnChild=(...c)=>{o.push(Yt(...c))},r.stopChild=(...c)=>{o.push(ct(...c))},i({context:e.context,event:e.event,enqueue:r,check:c=>J(c,t.context,e.event,t)}),[t,void 0,o]}function yn(n){function t(e,s){}return t.type="xstate.enqueueActions",t.collect=n,t.resolve=mn,t}const Qt=new WeakMap;function z(n,t,e){let s=Qt.get(n);return s?t in s||(s[t]=e()):(s={[t]:e()},Qt.set(n,s)),s[t]}const vn={},N=n=>typeof n=="string"?{type:n}:typeof n=="function"?"resolve"in n?{type:n.type}:{type:n.name}:n;class mt{constructor(t,e){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=e._parent,this.key=e._key,this.machine=e._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(B),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?Dt(this.config.states,(s,i)=>new mt(s,{_parent:this,_key:i,_machine:this.machine})):vn,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=T(this.config.entry).slice(),this.exit=T(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=T(t.tags).slice()}_initialize(){this.transitions=He(this),this.config.always&&(this.always=j(this.config.always).map(t=>k(this,bt,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(N),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(N),eventType:null})}:void 0,history:this.history,states:Dt(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(N)})),entry:this.entry.map(N),exit:this.exit.map(N),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return z(this,"invoke",()=>T(this.config.invoke).map((t,e)=>{const{src:s,systemId:i}=t,o=t.id??jt(this.id,e),r=typeof s=="string"?s:`xstate.invoke.${jt(this.id,e)}`;return{...t,src:r,id:o,systemId:i,toJSON(){const{onDone:c,onError:a,...h}=t;return{...h,type:"xstate.invoke",src:r,id:o}}}}))}get on(){return z(this,"on",()=>[...this.transitions].flatMap(([e,s])=>s.map(i=>[e,i])).reduce((e,[s,i])=>(e[s]=e[s]||[],e[s].push(i),e),{}))}get after(){return z(this,"delayedTransitions",()=>Ye(this))}get initial(){return z(this,"initial",()=>Ue(this,this.config.initial))}next(t,e){const s=e.type,i=[];let o;const r=z(this,`candidates-${s}`,()=>We(this,s));for(const c of r){const{guard:a}=c,h=t.context;let l=!1;try{l=!a||J(a,h,e,t)}catch(d){const u=typeof a=="string"?a:typeof a=="object"?a.type:void 0;throw new Error(`Unable to evaluate guard ${u?`'${u}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(l){i.push(...c.actions),o=c;break}}return o?[o]:void 0}get events(){return z(this,"events",()=>{const{states:t}=this,e=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const i=t[s];if(i.states)for(const o of i.events)e.add(`${o}`)}return Array.from(e)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(e=>this.transitions.get(e).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(t)}}const _n="#";class yt{constructor(t,e){this.config=t,this.version=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.__TResolvedTypesMeta=void 0,this.id=t.id||"(machine)",this.implementations={actors:(e==null?void 0:e.actors)??{},actions:(e==null?void 0:e.actions)??{},delays:(e==null?void 0:e.delays)??{},guards:(e==null?void 0:e.guards)??{}},this.version=this.config.version,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new mt(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:e,guards:s,actors:i,delays:o}=this.implementations;return new yt(this.config,{actions:{...e,...t.actions},guards:{...s,...t.guards},actors:{...i,...t.actors},delays:{...o,...t.delays}})}resolveState(t){const e=Qe(this.root,t.value),s=V(G(this.root,e));return Z({_nodes:[...s],context:t.context||{},children:{},status:at(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,e,s){return gt(t,e,s).snapshot}microstep(t,e,s){return gt(t,e,s).microstates}getTransitionData(t,e){return lt(this.root,t.value,t,e)||[]}getPreInitialState(t,e,s){const{context:i}=this.config,o=Z({context:typeof i!="function"&&i?i:{},_nodes:[this.root],children:{},status:"active"},this);return typeof i=="function"?U(o,e,t,[D(({spawn:c,event:a})=>i({spawn:c,input:a.input}))],s):o}getInitialSnapshot(t,e){const s=At(e),i=[],o=this.getPreInitialState(t,s,i),r=ft([{target:[...Lt(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],o,t,s,!0,i),{snapshot:c}=gt(r,s,t,i);return c}start(t){Object.values(t.children).forEach(e=>{e.getSnapshot().status==="active"&&e.start()})}getStateNodeById(t){const e=t.split(B),s=e.slice(1),i=K(e[0])?e[0].slice(_n.length):e[0],o=this.idMap.get(i);if(!o)throw new Error(`Child state node '#${i}' does not exist on machine '${this.id}'`);return q(o,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,e){return cn(t,e)}restoreSnapshot(t,e){const s={},i=t.children;Object.keys(i).forEach(a=>{const h=i[a],l=h.snapshot,d=h.src,u=typeof d=="string"?ot(this,d):d;if(!u)return;const f=X(u,{id:a,parent:e==null?void 0:e.self,syncSnapshot:h.syncSnapshot,snapshot:l,src:d,systemId:h.systemId});s[a]=f});const o=Z({...t,children:s,_nodes:Array.from(V(G(this.root,t.value)))},this);let r=new Set;function c(a,h){if(!r.has(a)){r.add(a);for(let l in a){const d=a[l];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===rt){a[l]=h[d.id];continue}c(d,h)}}}}return c(o.context,s),o}}function wn(n,t){return new yt(n,t)}const te=n=>n!=null;class Q extends M{constructor(e,s){super(e,S.createElementNS(v,"polygon"));m(this,"points",[]);s&&[s].flat().forEach(i=>this.addPoint(i.x,i.y))}updateElementPoints(){return this.element.setAttribute("points",this.points.map(e=>`${e.x},${e.y}`).join(" ")),this}addPoint(e,s){const i={x:e,y:s},o=et(i,(r,c,a,h)=>{var l,d;this._logWarnOnOpOnFrozen("Point moved on"),this.updateElementPoints(),r==="x"&&((l=h.handle)==null||l.setAttrX(c)),r==="y"&&((d=h.handle)==null||d.setAttrY(c))});return i.handle=new x(e,s,(r,c)=>{o.x+=r,o.y+=c},this.isFrozen),this.editorOwner.registerComponentHandle(i.handle),this.points.push(o),this.updateElementPoints(),this}moveLastPoint(e,s){const i=this.points[this.points.length-1];return[i.x,i.y]=[e,s],this}freeze(e){return this.isFrozen=e!=null?!!e:!0,this.getHandles().forEach(s=>s==null?void 0:s.freeze(e)),this}move(e,s){return this.points.forEach(i=>{i.x+=e,i.y+=s}),this}isValid(){return this.points.length>=3}setHandlesVisibility(e){return this.getHandles().forEach(s=>s.setVisible(e)),this}setIsSelected(e){return this._logWarnOnOpOnFrozen("Select/unselect performed on"),this.isSelected=e=e!=null?!!e:!0,this.setHandlesVisibility(e),this.style&&b(this.element,e?this.style.componentSelect.on:this.style.componentSelect.off),this}getHandles(){return this.points.map(e=>e.handle).filter(te)}setStyle(e){return this.style=e,b(this.element,e.component),b(this.element,e.componentHover.off),b(this.element,e.componentSelect.off),tt(this.element,e.componentHover.off,e.componentHover.on),this}export(){return this.points.map(e=>({x:e.x,y:e.y}))}}const Sn={rect:{on:{MT_DOWN:{actions:["createRectangle","selectUnfinished"],target:"#drawing.rect.mouseIsDown"}}},circle:{on:{MT_DOWN:{actions:["createCircle","selectUnfinished"],target:"#drawing.circle.mouseIsDown"}}},ellipse:{on:{MT_DOWN:{actions:["createEllipse","selectUnfinished"],target:"#drawing.ellipse.mouseIsDown"}}},polygon:{on:{MT_DOWN:{actions:["createPolygon","selectUnfinished"],target:"#drawing.polygon.mouseIsDown"}}}},bn={rect:{initial:"mouseIsUp",states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.rect",KEYDOWN_ESC:"#idle.drawMode.rect",MT_MOVE:{actions:"resizeUnfinished"}}},mouseIsUp:{}}},circle:{initial:"mouseIsUp",states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.circle",KEYDOWN_ESC:"#idle.drawMode.circle",MT_MOVE:{actions:"resizeUnfinished"}}},mouseIsUp:{}}},ellipse:{initial:"mouseIsUp",states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.ellipse",KEYDOWN_ESC:"#idle.drawMode.ellipse",MT_MOVE:{actions:"resizeUnfinished"}}},mouseIsUp:{}}},polygon:{on:{KEYDOWN_ESC:"#idle.drawMode.polygon"},initial:"mouseIsUp",states:{mouseIsDown:{on:{MT_UP:"mouseIsUp",MT_MOVE:{actions:"moveLastPoint"}}},mouseIsUp:{on:{MT_DOWN:[{guard:"isHandle",target:"#idle.drawMode.polygon"},{actions:"addPoint",target:"mouseIsDown"}]}}}}},En=n=>wn({context:{unfinishedComponent:void 0,mouseDownInSelectModeObject:void 0,_editor:n},on:{MODE_SELECT:".idle.selectMode",MODE_DRAW_RECT:".idle.drawMode.rect",MODE_DRAW_CIRCLE:".idle.drawMode.circle",MODE_DRAW_ELLIPSE:".idle.drawMode.ellipse",MODE_DRAW_POLYGON:".idle.drawMode.polygon"},initial:"idle",states:{idle:{id:"idle",initial:"selectMode",states:{selectMode:{initial:"mouseIsUp",states:{mouseIsUp:{on:{MT_DOWN:{actions:["selectComponent","mouseDownInSelectModeAssign"],target:"mouseIsDown"},KEYDOWN_ARROW:{actions:"mouseDownInSelectModeObjectMove"}}},mouseIsDown:{on:{MT_UP:"mouseIsUp",MT_MOVE:{actions:"mouseDownInSelectModeObjectMove"}}}},on:{KEYDOWN_ESC:{actions:["unselectAll","mouseDownInSelectModeUnassign"]},KEYDOWN_DEL:{actions:["deleteComponent","mouseDownInSelectModeUnassign"]},mouseDownInSelectModeUnassign:{actions:"mouseDownInSelectModeUnassign"}},entry:"selectModeEntry",exit:["unselectAll","mouseDownInSelectModeUnassign"]},drawMode:{initial:"polygon",states:Sn,on:{KEYDOWN_ESC:"#idle.selectMode"}}}},drawing:{id:"drawing",initial:"polygon",states:bn,exit:yn(({enqueue:t,check:e})=>{e("unfinishedIsValid")?(t("unselectAll"),t("validComponentFinished")):t("discardUnfinished")})}}},{actions:{createRectangle:D({unfinishedComponent:t=>t.context._editor.createRectangle({x:t.event.offsetX,y:t.event.offsetY,width:0,height:0})}),createCircle:D({unfinishedComponent:t=>t.context._editor.createCircle({x:t.event.offsetX,y:t.event.offsetY,width:0,height:0})}),createEllipse:D({unfinishedComponent:t=>t.context._editor.createEllipse({x:t.event.offsetX,y:t.event.offsetY,width:0,height:0})}),createPolygon:D({unfinishedComponent:t=>t.context._editor.createPolygon({x:t.event.offsetX,y:t.event.offsetY})}),discardUnfinished:t=>{t.context.unfinishedComponent&&t.context._editor.unregisterComponent(t.context.unfinishedComponent)},resizeUnfinished:t=>{t.context.unfinishedComponent instanceof P&&t.context.unfinishedComponent.resize(t.event.offsetX,t.event.offsetY)},selectUnfinished:t=>{t.context._editor.selectComponent(t.context.unfinishedComponent)},validComponentFinished:t=>{const e=t.context.unfinishedComponent;e&&t.context._editor.componentDrawnHandler&&t.context._editor.componentDrawnHandler(e,e.element.id)},addPoint:t=>{t.context.unfinishedComponent instanceof Q&&t.context.unfinishedComponent.addPoint(t.event.offsetX,t.event.offsetY),t.context._editor.selectComponent(t.context.unfinishedComponent)},moveLastPoint:t=>{t.context.unfinishedComponent instanceof Q&&t.context.unfinishedComponent.moveLastPoint(t.event.offsetX,t.event.offsetY)},mouseDownInSelectModeAssign:D({mouseDownInSelectModeObject:t=>t.event.component}),mouseDownInSelectModeUnassign:D({mouseDownInSelectModeObject:void 0}),mouseDownInSelectModeObjectMove:t=>{const e=t.context.mouseDownInSelectModeObject;e&&e.move&&e.move(t.event.movementX,t.event.movementY)},selectComponent:t=>{t.context._editor.selectComponent(t.event.component)},deleteComponent:t=>{const e=t.context.mouseDownInSelectModeObject;e&&t.context._editor.unregisterComponent(e)},unselectAll:t=>{t.context._editor.selectComponent(void 0)},selectModeEntry:t=>{t.context._editor.selectModeHandler&&t.context._editor.selectModeHandler()}},guards:{isHandle:t=>t.event.component instanceof x,unfinishedIsValid:t=>{var e;return!!((e=t.context.unfinishedComponent)!=null&&e.isValid())}}}),xn=n=>X(En(n));class ee extends P{constructor(t,e,s,i=0,o=0){super("rect",{x:(r,c,a,h)=>{r.setAttribute("x",String(h.width<0?c+h.width:c))},y:(r,c,a,h)=>{r.setAttribute("y",String(h.height<0?c+h.height:c))},width:(r,c,a,h)=>{r.setAttribute("width",String(Math.abs(c))),r.setAttribute("x",String(c<0?h.x+c:h.x))},height:(r,c,a,h)=>{r.setAttribute("height",String(Math.abs(c))),r.setAttribute("y",String(c<0?h.y+c:h.y))}},t,e,s,i,o)}}class ne extends P{constructor(t,e,s,i=0,o=0){super("circle",{x:(r,c,a,h)=>{r.setAttribute("cx",String(c+h.width/2))},y:(r,c,a,h)=>{r.setAttribute("cy",String(c+h.height/2))},width:(r,c,a,h)=>{r.setAttribute("r",String(Math.min(Math.abs(c),Math.abs(h.height))/2)),r.setAttribute("cx",String(h.x+c/2))},height:(r,c,a,h)=>{r.setAttribute("r",String(Math.min(Math.abs(c),Math.abs(h.width))/2)),r.setAttribute("cy",String(h.y+c/2))}},t,e,s,i,o)}}class se extends P{constructor(t,e,s,i=0,o=0){super("ellipse",{x:(r,c,a,h)=>{r.setAttribute("cx",String(c+h.width/2))},y:(r,c,a,h)=>{r.setAttribute("cy",String(c+h.height/2))},width:(r,c,a,h)=>{r.setAttribute("rx",String(Math.abs(c)/2)),r.setAttribute("cx",String(h.x+c/2))},height:(r,c,a,h)=>{r.setAttribute("ry",String(Math.abs(c)/2)),r.setAttribute("cy",String(h.y+c/2))}},t,e,s,i,o)}}const ie=n=>{if(typeof n=="object"&&n!==null){if(typeof Object.getPrototypeOf=="function"){const t=Object.getPrototypeOf(n);return t===Object.prototype||t===null}return Object.prototype.toString.call(n)==="[object Object]"}return!1},E=(...n)=>n.reduce((t,e)=>{if(Array.isArray(e))throw new TypeError("Arguments provided to ts-deepmerge must be objects, not arrays.");return Object.keys(e).forEach(s=>{["__proto__","constructor","prototype"].includes(s)||(Array.isArray(t[s])&&Array.isArray(e[s])?t[s]=E.options.mergeArrays?E.options.uniqueArrayItems?Array.from(new Set(t[s].concat(e[s]))):[...t[s],...e[s]]:e[s]:ie(t[s])&&ie(e[s])?t[s]=E(t[s],e[s]):t[s]=e[s]===void 0?E.options.allowUndefinedOverrides?e[s]:t[s]:e[s])}),t},{}),vt={allowUndefinedOverrides:!0,mergeArrays:!0,uniqueArrayItems:!0};E.options=vt,E.withOptions=(n,...t)=>{E.options=Object.assign(Object.assign({},vt),n);const e=E(...t);return E.options=vt,e};class _t{constructor(t,e={},s={}){m(this,"width");m(this,"height");m(this,"componentDrawnHandler");m(this,"selectModeHandler");m(this,"viewClickHandler");m(this,"svg");m(this,"cgroup");m(this,"hgroup");m(this,"style");m(this,"fsmService");m(this,"_cacheElementMapping");m(this,"_idCounter");m(this,"_handleIdCounter");if(this.width=e.width??1200,this.height=e.height??600,this.componentDrawnHandler=e.componentDrawnHandler,this.selectModeHandler=e.selectModeHandler,this.viewClickHandler=e.viewClickHandler,this.style=E.withOptions({allowUndefinedOverrides:!1},wt(),s),this.fsmService=xn(this).start(),t instanceof SVGSVGElement)this.svg=t;else if(typeof t=="string"||t instanceof String){const i=S.querySelector(`#${t}`);if(i)this.svg=i;else{this.svg=S.createElementNS(v,"svg"),this.svg.setAttribute("version","1.1"),this.svg.setAttribute("id",t),this.svg.setAttribute("width",String(this.width)),this.svg.setAttribute("height",String(this.height)),this.svg.setAttribute("viewBox",`0, 0, ${this.width} ${this.height}`),this.svg.setAttribute("preserveAspectRatio","xMinYMin");const o=this.svg;window.addEventListener("load",function(){S.body.appendChild(o)},{once:!0})}}this.cgroup=S.createElementNS(v,"g"),this.hgroup=S.createElementNS(v,"g"),this.svg.appendChild(this.cgroup),this.svg.appendChild(this.hgroup),this._cacheElementMapping=et({},(i,o,r)=>{o?o instanceof x?this.hgroup.appendChild(o.element):this.cgroup.appendChild(o.element):r instanceof x?this.hgroup.removeChild(r.element):(this.cgroup.removeChild(r.element),r.getHandles().forEach(c=>{this.unregisterComponent(c)}))}),this._idCounter=1,this._handleIdCounter=1}loadImage(t,e,s){const i=S.createElementNS(v,"image");return i.setAttributeNS(C,"href",t),e!=null&&i.setAttribute("width",String(e)),s!=null&&i.setAttribute("height",String(s)),this.svg.prepend(i),this}setStyle(t){return this.style=E.withOptions({allowUndefinedOverrides:!1},this.style,t),this}rect(){this.fsmService.send({type:"MODE_DRAW_RECT"})}circle(){this.fsmService.send({type:"MODE_DRAW_CIRCLE"})}ellipse(){this.fsmService.send({type:"MODE_DRAW_ELLIPSE"})}polygon(){this.fsmService.send({type:"MODE_DRAW_POLYGON"})}selectMode(){this.fsmService.send({type:"MODE_SELECT"})}getComponentById(t){return this._cacheElementMapping&&this._cacheElementMapping[t]}selectComponent(t){let e;return typeof t=="string"||t instanceof String?e=this.getComponentById(t):e=t,Object.values(this._cacheElementMapping).forEach(s=>{s instanceof M&&(s===e&&s.setIsSelected(!0),s!==e&&!s.isFrozen&&s.setIsSelected(!1))}),e instanceof M?e:null}removeComponent(t){let e;return typeof t=="string"||t instanceof String?e=this.getComponentById(t):e=t,e instanceof M?(this.unregisterComponent(e),e):null}on(t,e){return O(this.svg,t,e),this}off(t,e){return he(this.svg,t,e),this}import(t,e){const s=JSON.parse(t);return this._idCounter=s.idCounter,s.components.map(i=>{const o=e?e(i.id):i.id;switch(i.type){case"rect":return this.createRectangle(i.data,o);case"circle":return this.createCircle(i.data,o);case"ellipse":return this.createEllipse(i.data,o);case"polygon":return this.createPolygon(i.data,o);default:return console.error("Unknown type",i.type),null}}).filter(te)}export(t){const e=Object.entries(this._cacheElementMapping).filter(([,o])=>o instanceof M),s={idCounter:this._idCounter,components:e.map(([o,r])=>({id:o,type:r.element.tagName,data:r.export()}))},i=JSON.stringify(s);return t?i.replace(/[\"]/g,'\\"'):i}createRectangle(t,e){const{x:s,y:i,width:o,height:r}=t;return this.registerComponent(new ee(this,s,i,o,r).setStyle(this.style),e)}createCircle(t,e){const{x:s,y:i,width:o,height:r}=t;return this.registerComponent(new ne(this,s,i,o,r).setStyle(this.style),e)}createEllipse(t,e){const{x:s,y:i,width:o,height:r}=t;return this.registerComponent(new se(this,s,i,o,r).setStyle(this.style),e)}createPolygon(t,e){return this.registerComponent(new Q(this,t).setStyle(this.style),e)}registerComponent(t,e){return t instanceof x?e="handle_"+this._handleIdCounter++:e=e||t.element.tagName+"_"+this._idCounter++,this._cacheElementMapping[e]=t,t.element.id=e,t}registerComponentHandle(t){return this.registerComponent(t.setStyle(this.style.handle,this.style.handleHover))}unregisterComponent(t){t instanceof M&&t._logWarnOnOpOnFrozen("Deleting"),this._cacheElementMapping[t.element.id]=void 0,delete this._cacheElementMapping[t.element.id]}}const An=n=>{let t;return O(n.svg,"mousedown touchstart",e=>{var h;e.preventDefault();const s=n.getComponentById((h=e.target)==null?void 0:h.id),i=s&&s.isFrozen?void 0:s,o=e instanceof MouseEvent?e:null,r=e instanceof TouchEvent?e:null,c=n.svg.getBoundingClientRect(),a=r==null?void 0:r.targetTouches[0];n.fsmService.send({type:"MT_DOWN",component:i,offsetX:(o==null?void 0:o.offsetX)??(a&&a.clientX-c.x)??0,offsetY:(o==null?void 0:o.offsetY)??(a&&a.clientY-c.y)??0}),t=a}),O(n.svg,"mouseup touchend mouseleave touchleave",e=>{e.preventDefault(),n.fsmService.send({type:"MT_UP"}),t=void 0}),O(n.svg,"mousemove touchmove",e=>{const s=e instanceof MouseEvent?e:null,i=e instanceof TouchEvent?e:null,o=n.svg.getBoundingClientRect(),r=i==null?void 0:i.targetTouches[0];n.fsmService.send({type:"MT_MOVE",offsetX:(s==null?void 0:s.offsetX)??(r&&r.clientX-o.x)??0,offsetY:(s==null?void 0:s.offsetY)??(r&&r.clientY-o.y)??0,movementX:(s==null?void 0:s.movementX)!=null?s.movementX:t&&r?r.clientX-t.clientX:0,movementY:(s==null?void 0:s.movementY)!=null?s.movementY:t&&r?r.clientY-t.clientY:0}),t=r}),O(window,"keydown",e=>{const s=e;switch(s.key){case"Escape":n.fsmService.send({type:"KEYDOWN_ESC"});break;case"Delete":n.fsmService.send({type:"KEYDOWN_DEL"});break;case"ArrowUp":s.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARROW",movementX:0,movementY:-1});break;case"ArrowDown":s.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARROW",movementX:0,movementY:1});break;case"ArrowLeft":s.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARROW",movementX:-1,movementY:0});break;case"ArrowRight":s.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARROW",movementX:1,movementY:0});break}}),n},On=n=>(O(n.cgroup,"click touchstart",t=>{var e;t.preventDefault(),n.viewClickHandler&&n.viewClickHandler(t,(e=t.target)==null?void 0:e.id)}),n),oe=n=>function(...e){return n?On(new _t(...e)):An(new _t(...e))},re=oe(),ce=oe(!0),Mn={editor:re,view:ce};y.Circle=ne,y.Component=M,y.CornerShapedElement=P,y.Editor=_t,y.Ellipse=se,y.Polygon=Q,y.Rectangle=ee,y.default=Mn,y.editor=re,y.view=ce,Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=imagemapper.umd.js.map
